<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Dashboard</title>
  <style>
    /* [Todo el estilo se mantiene igual, ya lo tienes completo y bien hecho] */
    /* ... */
  </style>
</head>
<body>
  <div class="header-buttons">
    <button class="admin-btn" onclick="goToAdmin()">Admin Panel</button>
    <button class="admin-btn" onclick="goToHistory()">View History</button>
    <button id="loginLogoutBtn" class="logout-btn" onclick="handleLoginLogout()">Logout</button>
  </div>

  <h1>Task Dashboard</h1>
  <div id="task-container"></div>
  <div id="pagination"></div>

  <div id="modal">
    <div id="modal-content">
      <div id="modal-message">Espera, reservando tu tarea...</div>
      <div class="spinner"></div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const BASE_URL = "https://remo-task-manager-production.up.railway.app";
    const CLAIM_URL = BASE_URL + "/api/claim";
    const FINISH_URL = BASE_URL + "/api/mark-finished";

    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) {
      alert("Session expired. Please log in again.");
      window.location.href = "login.html";
      return;
    }

    const taskContainer = document.getElementById("task-container");
    const modal = document.getElementById("modal");
    const modalMessage = document.getElementById("modal-message");
    const TASKS_PER_PAGE = 36;
    let currentPage = 1;
    let allTasks = [];

    function showModal(message) {
      modalMessage.textContent = message;
      modal.style.display = "flex";
    }

    function hideModal() {
      modal.style.display = "none";
    }

    function goToAdmin() { window.location.href = "admin.html"; }
    function goToHistory() {
      if (currentUser.role === "admin") {
        window.location.href = "historial.html";
      } else {
        alert("Access denied. Admin only.");
      }
    }
    function handleLoginLogout() {
      localStorage.clear();
      window.location.href = "login.html";
    }
    function truncate(text) {
      return text?.length > 10 ? text.slice(0, 10) + "…" : text;
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${BASE_URL}/api/tasks?username=${currentUser.username}`);
        const data = await res.json();
        const username = currentUser.username?.toLowerCase();

        allTasks = data
          .filter(task => {
            const claimedBy = task.claimed_by?.toLowerCase() || "";
            const status = task.status?.toLowerCase();
            const isMine = claimedBy === username;
            return status !== "finished" || isMine;
          })
          .map(task => ({
            Subtask: task.subtask,
            Batch: task.batch,
            Level: task.level,
            Status: task.status,
            ClaimedBy: task.claimed_by,
            Project: task.project
          }));

        const myClaimedTask = localStorage.getItem("lastClaimedTask") || "";
        const stillValid = allTasks.some(
          t => t.Subtask === myClaimedTask && t.ClaimedBy?.toLowerCase() === username
        );
        if (!stillValid) {
          localStorage.removeItem("lastClaimedTask");
        }

        renderPage(currentPage);
      } catch (err) {
        console.error("❌ Error loading tasks:", err);
      }
    }

    // [Incluye aquí tu renderPage() y demás funciones exactamente como ya las tenías]

    loadTasks();
  });
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.on("taskClaimed", ({ subtask }) => loadTasks());
    socket.on("taskFinished", ({ subtask }) => {
      const claimed = localStorage.getItem("lastClaimedTask");
      if (claimed === subtask) {
        localStorage.removeItem("lastClaimedTask");
        localStorage.removeItem("claimedAt");
      }
      const card = document.querySelector(`.task-card[data-subtask="${subtask}"]`);
      if (card) card.remove(); else loadTasks();
    });
  </script>
</body>
</html>