<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      padding: 2rem;
      color: #2c3e50;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #34495e;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .project-card {
      background: white;
      padding: 20px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .level-options {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .save-btn {
      background: #3498db;
      color: white;
      padding: 10px 16px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }

    .save-btn:hover {
      background: #2980b9;
    }

    .message {
      text-align: center;
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<h1>Manage Projects</h1>

<label for="projectSelector">Select Project:</label>
<select id="projectSelector">
  <option value="">-- Choose a Project --</option>
</select>

<div id="editor" class="project-card" style="display: none;">
  <label>
    <input type="checkbox" id="keepName" checked />
    Do not change project name
  </label>

  <label for="newProjectName">New Project Name (optional):</label>
  <input type="text" id="newProjectName" disabled />

  <label>Levels:</label>
  <div class="level-options" id="levelOptions"></div>

  <label>Pause Button:</label>
  <select id="pauseSelect">
    <option value="disabled">Disabled</option>
    <option value="enabled">Enabled</option>
  </select>

  <button class="save-btn" onclick="saveChanges()">Save Changes</button>
</div>

<div class="message" id="message"></div>

<script>
  const BASE_URL = "https://remo-task-manager-production.up.railway.app";
  const LEVELS = ["-1", "0", "1", "10"];
  let allProjects = [];

  const projectSelector = document.getElementById("projectSelector");
  const editor = document.getElementById("editor");
  const newNameInput = document.getElementById("newProjectName");
  const keepNameCheckbox = document.getElementById("keepName");
  const levelContainer = document.getElementById("levelOptions");
  const pauseSelect = document.getElementById("pauseSelect");
  const messageDiv = document.getElementById("message");

  keepNameCheckbox.addEventListener("change", () => {
    newNameInput.disabled = keepNameCheckbox.checked;
  });

  async function loadProjects() {
    const res = await fetch(`${BASE_URL}/api/projects`);
    allProjects = await res.json();

    allProjects.forEach(p => {
      const option = document.createElement("option");
      option.value = p.name;
      option.textContent = p.name;
      projectSelector.appendChild(option);
    });
  }

  projectSelector.addEventListener("change", () => {
    const selected = allProjects.find(p => p.name === projectSelector.value);
    if (!selected) return;

    newNameInput.value = "";
    keepNameCheckbox.checked = true;
    newNameInput.disabled = true;

    pauseSelect.value = selected.pause;
    levelContainer.innerHTML = "";
    LEVELS.forEach(level => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${level}" ${selected.levels.includes(level) ? 'checked' : ''}/> ${level}`;
      levelContainer.appendChild(label);
    });

    editor.style.display = "block";
    messageDiv.textContent = "";
  });

  async function saveChanges() {
    const originalName = projectSelector.value;
    const newName = keepNameCheckbox.checked ? originalName : newNameInput.value.trim();
    const pause = pauseSelect.value;
    const levels = Array.from(levelContainer.querySelectorAll("input:checked")).map(cb => cb.value);

    if (!originalName) {
      alert("Select a project first.");
      return;
    }

    const res = await fetch(`${BASE_URL}/api/update-project`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ originalName, newName, pause, levels })
    });

    const json = await res.json();
    if (json.status === "success") {
      messageDiv.textContent = "✅ Project updated successfully.";
      messageDiv.style.color = "green";
      await loadProjects();
    } else {
      messageDiv.textContent = "❌ " + (json.message || "Update failed.");
      messageDiv.style.color = "red";
    }
  }

  loadProjects();
</script>
</body>
</html>
