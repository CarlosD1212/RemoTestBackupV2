<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f1113;
      color: #ecf0f1;
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #a9cce3;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 20px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #1c1f22;
      color: #ecf0f1;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #bdc3c7;
    }

    .project-card {
      background: #1e2226;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      margin-top: 10px;
    }

    .level-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .actions {
      text-align: right;
      margin-top: 20px;
    }

    .save-btn {
      background: #3498db;
      border: none;
      color: white;
      padding: 10px 16px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .save-btn:hover {
      background: #2980b9;
    }

    .message {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Manage Projects</h1>

  <label for="project-select">Select Project:</label>
  <select id="project-select">
    <option value="">-- Choose a Project --</option>
  </select>

  <div id="editor-container"></div>
  <div id="message" class="message"></div>

  <script>
    const BASE_URL = "https://remo-task-manager-production.up.railway.app";
    let allProjects = [];

    async function loadProjects() {
      const projectSelector = document.getElementById("project-select");
      const editorContainer = document.getElementById("editor-container");

      try {
        const res = await fetch(`${BASE_URL}/api/projects`);
        if (!res.ok) throw new Error("API error");
        allProjects = await res.json();
      } catch (e) {
        console.warn("Using fallback");
        allProjects = [
          { name: "Test Project", levels: ["0", "1"], pause: "enabled" },
          { name: "Otro Proyecto", levels: ["-1", "10"], pause: "disabled" }
        ];
      }

      projectSelector.innerHTML = `<option value="">-- Choose a Project --</option>`;
      allProjects.forEach(p => {
        const option = document.createElement("option");
        option.value = p.name;
        option.textContent = p.name;
        projectSelector.appendChild(option);
      });

      projectSelector.onchange = () => {
        const selected = allProjects.find(p => p.name === projectSelector.value);
        if (!selected) {
          editorContainer.innerHTML = "";
          return;
        }

        editorContainer.innerHTML = `
          <div class="project-card">
            <label>Project Name</label>
            <input type="text" class="project-name" value="${selected.name}" />
            <label><input type="checkbox" id="no-rename"> Don't change project name</label>

            <label>Levels</label>
            <div class="level-options">
              ${["-1", "0", "1", "10"].map(level => `
                <label>
                  <input type="checkbox" value="${level}" ${selected.levels?.includes(level) ? "checked" : ""}/> ${level}
                </label>
              `).join('')}
            </div>

            <label>Pause Button</label>
            <select class="pause-option">
              <option value="disabled" ${selected.pause === "disabled" ? "selected" : ""}>Disabled</option>
              <option value="enabled" ${selected.pause === "enabled" ? "selected" : ""}>Enabled</option>
            </select>

            <div class="actions">
              <button class="save-btn">Save Changes</button>
            </div>
          </div>
        `;

        editorContainer.querySelector(".save-btn").onclick = async () => {
          const newName = editorContainer.querySelector(".project-name").value.trim();
          const pause = editorContainer.querySelector(".pause-option").value;
          const levels = Array.from(editorContainer.querySelectorAll(".level-options input:checked")).map(cb => cb.value);

          const body = {
            originalName: selected.name,
            newName: document.getElementById("no-rename").checked ? selected.name : newName,
            levels,
            pause
          };

          const res = await fetch(`${BASE_URL}/api/update-project`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          const result = await res.json();
          const msg = document.getElementById("message");
          if (result.status === "success") {
            msg.textContent = "✅ Project updated successfully.";
            msg.style.color = "lightgreen";
            loadProjects(); // refrescar por si cambió el nombre
          } else {
            msg.textContent = "❌ Error: " + result.message;
            msg.style.color = "red";
          }
        };
      };
    }

    loadProjects();
  </script>
</body>
</html>
